---
- name: Ensure consul package installed
  ansible.builtin.apt:
    name: consul
    state: present
    update-cache: true

- name: Remove config directory
  ansible.builtin.file:
    dest: /etc/consul.d
    state: absent
  when: clean

- name: Check / create the config directory exists
  ansible.builtin.file:
    dest: /etc/consul.d
    state: directory
    owner: consul
    group: consul
    mode: "0755"

- name: Check / create the data directory exists
  ansible.builtin.file:
    dest: /opt/consul
    state: directory
    owner: consul
    group: consul
    mode: "0755"

- name: Copy server config
  ansible.builtin.copy:
    src: consul.server.config.hcl
    dest: /etc/consul.d/server.hcl
    owner: consul
    group: consul
    mode: "0644"
    force: true
  notify:
    - Restart consul
  ignore_errors: '{{ ansible_check_mode }}'
  when: "'consul_servers' in group_names"

- name: Copy client config
  ansible.builtin.copy:
    src: consul.client.config.hcl
    dest: /etc/consul.d/client.hcl
    owner: consul
    group: consul
    mode: "0644"
    force: true
  notify:
    - Restart consul
  ignore_errors: '{{ ansible_check_mode }}'
  when: "'consul_clients' in group_names"

- name: Copy shared config
  ansible.builtin.copy:
    src: consul.agentshared.config.hcl
    dest: /etc/consul.d/agent.hcl
    owner: consul
    group: consul
    mode: "0644"
    force: true
  notify:
    - Restart consul
  ignore_errors: '{{ ansible_check_mode }}'

- name: Copy service unit file
  ansible.builtin.copy:
    src: consul.service
    dest: /etc/systemd/system/consul.service
    owner: consul
    group: consul
    mode: "0644"
    force: true
  notify:
    - Restart consul
  ignore_errors: '{{ ansible_check_mode }}'
